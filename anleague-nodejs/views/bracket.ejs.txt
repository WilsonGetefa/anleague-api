<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" type="image/x-icon" href="/images/caf.png">
  <style>
    .bracket-container { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 20px; }
    .bracket-round { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; }
    .match { 
      border: 1px solid #ccc; 
      padding: 12px; 
      margin: 10px 0; 
      border-radius: 6px; 
      background: #f9f9f9;
      min-width: 280px;
    }
    .match a { text-decoration: none; color: #333; font-weight: 500; }
    .in-progress { color: #FFA500; font-weight: bold; }
    .completed { color: #28a745; font-weight: bold; }
    .winner {
      font-weight: bold;
      color: #d4af37;
      margin-top: 8px;
      font-size: 0.95em;
    }
    .champion-banner {
      text-align: center;
      margin: 40px 0;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 2px solid #d4af37;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
    }
    .champion-banner h2 { color: #d4af37; margin: 0; font-size: 1.8em; }
    .champion-banner p { margin: 8px 0 0; font-size: 1.1em; color: #555; }
    @media (max-width: 600px) {
      .bracket-round { flex-direction: column; align-items: center; }
      .match { min-width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Tournament Bracket</h1>
  </header>
  <nav>
    <a href="/">Home</a> |
    <a href="/bracket">Bracket</a> |
    <a href="/rankings">Rankings</a> |
    <a href="/teams">Teams</a> |
    <% if (user) { %>
      <% if (user.role === 'admin') { %>
        <a href="/admin/dashboard">Admin Dashboard</a> |
      <% } else { %>
        <a href="/dashboard">Dashboard</a> |
      <% } %>
      <a href="/auth/logout">Logout</a>
    <% } else { %>
      <a href="/login">Login</a> |
      <a href="/signup">Sign Up</a>
    <% } %>
  </nav>

  <main class="container bracket-container">
    <% if (message) { %>
      <p style="color: #28a745; font-weight: bold;"><%= message %></p>
    <% } else if (error) { %>
      <p style="color: #dc3545; font-weight: bold;"><%= error %></p>
    <% } else if (tournament) { %>

      <h2>ROAD TO THE FINAL</h2>
      <h2>Current Tournament Bracket</h2>

      <!-- REUSABLE WINNER FUNCTION -->
      <% const getWinner = (m) => {
        if (!m?.match_id || m.match_id.status !== 'completed') return null;
        const t1 = m.team1_id?.country || 'Unknown';
        const t2 = m.team2_id?.country || 'Unknown';
        return m.match_id.score.team1 > m.match_id.score.team2 ? t1 : t2;
      }; %>

      <div class="bracket-round">
        <!-- QUARTERFINALS -->
        <div>
          <h3>Quarterfinals</h3>
          <ul style="list-style: none; padding: 0;">
            <% (tournament.bracket.quarterfinals || []).forEach(match => { %>
              <% if (match.match_id && match.match_id._id) { %>
                <% const winner = getWinner(match); %>
                <li class="match">
                  <a href="/match/<%= match.match_id._id %>">
                    <%= match.team1_id?.country || 'TBD' %> vs
                    <%= match.team2_id?.country || 'TBD' %>
                    <% if (match.match_id.score?.team1 != null) { %>
                      (<%= match.match_id.score.team1 %> - <%= match.match_id.score.team2 %>)
                    <% } %>
                  </a>
                  <% if (match.match_id.status === 'in_progress') { %>
                    <span class="in-progress"> (In Progress)</span>
                  <% } else if (match.match_id.status === 'completed') { %>
                    <span class="completed"> (Completed)</span>
                  <% } %>
                  <% if (match.match_id.commentary) { %>
                    <p style="margin: 6px 0; font-size: 0.9em; color: #555;"><%= match.match_id.commentary %></p>
                  <% } %>
                  <% if (winner && winner !== 'Unknown') { %>
                    <p class="winner">Winner: <%= winner %></p>
                  <% } %>
                </li>
              <% } %>
            <% }) %>
          </ul>
        </div>

        <!-- SEMIFINALS -->
        <div>
          <h3>Semifinals</h3>
          <ul style="list-style: none; padding: 0;">
            <% (tournament.bracket.semifinals || []).forEach(match => { %>
              <% if (match.match_id && match.match_id._id) { %>
                <% const winner = getWinner(match); %>
                <li class="match">
                  <a href="/match/<%= match.match_id._id %>">
                    <%= match.team1_id?.country || 'TBD' %> vs
                    <%= match.team2_id?.country || 'TBD' %>
                    <% if (match.match_id.score?.team1 != null) { %>
                      (<%= match.match_id.score.team1 %> - <%= match.match_id.score.team2 %>)
                    <% } %>
                  </a>
                  <% if (match.match_id.status === 'in_progress') { %>
                    <span class="in-progress"> (In Progress)</span>
                  <% } else if (match.match_id.status === 'completed') { %>
                    <span class="completed"> (Completed)</span>
                  <% } %>
                  <% if (match.match_id.commentary) { %>
                    <p style="margin: 6px 0; font-size: 0.9em; color: #555;"><%= match.match_id.commentary %></p>
                  <% } %>
                  <% if (winner && winner !== 'Unknown') { %>
                    <p class="winner">Winner: <%= winner %></p>
                  <% } %>
                </li>
              <% } %>
            <% }) %>
          </ul>
        </div>

        <!-- FINAL -->
        <div>
          <h3>Final</h3>
          <ul style="list-style: none; padding: 0;">
            <% (tournament.bracket.final || []).forEach(match => { %>
              <% if (match.match_id && match.match_id._id) { %>
                <% const winner = getWinner(match); %>
                <li class="match">
                  <a href="/match/<%= match.match_id._id %>">
                    <%= match.team1_id?.country || 'TBD' %> vs
                    <%= match.team2_id?.country || 'TBD' %>
                    <% if (match.match_id.score?.team1 != null) { %>
                      (<%= match.match_id.score.team1 %> - <%= match.match_id.score.team2 %>)
                    <% } %>
                  </a>
                  <% if (match.match_id.status === 'in_progress') { %>
                    <span class="in-progress"> (In Progress)</span>
                  <% } else if (match.match_id.status === 'completed') { %>
                    <span class="completed"> (Completed)</span>
                  <% } %>
                  <% if (match.match_id.commentary) { %>
                    <p style="margin: 6px 0; font-size: 0.9em; color: #555;"><%= match.match_id.commentary %></p>
                  <% } %>
                  <% if (winner && winner !== 'Unknown') { %>
                    <p class="winner">Winner: <%= winner %></p>
                  <% } %>
                </li>
              <% } %>
            <% }) %>
          </ul>
        </div>
      </div>

      <!-- CHAMPION BANNER -->
      <% if (tournament.status === 'completed' && tournament.bracket.final[0]?.match_id?.status === 'completed') { %>
        <% const champion = getWinner(tournament.bracket.final[0]); %>
        <% if (champion && champion !== 'Unknown') { %>
          <div class="champion-banner">
            <h2>Champion: <%= champion %></h2>
            <p>African Nations League <%= new Date().getFullYear() %> Champions</p>
          </div>
        <% } %>
      <% } %>

    <% } else if (pastTournaments.length > 0) { %>
      <h2>Past Tournaments</h2>
      <% pastTournaments.forEach(pt => { %>
        <h3>Year: <%= pt.year %></h3>
        <div class="bracket-round">
          <% ['quarterfinals', 'semifinals', 'final'].forEach(stage => { %>
            <div>
              <h4><%= stage.charAt(0).toUpperCase() + stage.slice(1) %></h4>
              <ul style="list-style: none; padding: 0;">
                <% pt.bracket[stage].forEach(f => { %>
                  <% const pastWinner = f.match_id.score.team1 > f.match_id.score.team2 
                        ? f.team1_id?.country || 'Unknown' 
                        : f.team2_id?.country || 'Unknown'; %>
                  <li class="match">
                    <%= f.team1_id?.country || 'TBD' %> vs <%= f.team2_id?.country || 'TBD' %> 
                    - <%= f.match_id.score.team1 %>-<%= f.match_id.score.team2 %>
                    <% if (f.match_id.commentary) { %>
                      <p style="margin: 6px 0; font-size: 0.9em; color: #555;"><%= f.match_id.commentary %></p>
                    <% } %>
                    <% if (pastWinner !== 'Unknown') { %>
                      <p class="winner">Winner: <%= pastWinner %></p>
                    <% } %>
                  </li>
                <% }); %>
              </ul>
            </div>
          <% }); %>
        </div>
      <% }); %>
    <% } else { %>
      <p>No tournament data available</p>
    <% } %>
  </main>
</body>
</html>