<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" type="image/x-icon" href="/images/caf.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js" integrity="sha512-+ + +sha384-... (trimmed for brevity) + + +"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root {
      --primary: #2e6b5b;
      --primary-dark: #1a3f35;
      --accent: #e67e22;
      --light: #f8f9fa;
      --gray: #6c757d;
      --border: #dee2e6;
      --gold: #d4af37;
      --empty-star: #cccccc;
      --danger: #dc3545;
      --success: #28a745;
    }
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f6f9;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    header {
      text-align: center;
      padding: 2rem 1rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 0 0 16px 16px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    header h1 { margin: 0; font-size: 2rem; font-weight: 700; }
    nav {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    nav a { margin: 0 6px; color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.95rem; }
    nav a:hover { color: var(--accent); }
  
    .sticky-top {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .sticky-top header {
      text-align: center;
      padding: 1rem 1rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 0 0 16px 16px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .sticky-top nav {
      background: white;
      padding: 1rem 1rem;
      text-align: center;
      border-bottom: 1px solid #eee;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .sticky-top nav a {
      margin: 0 10px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      transition: color 0.2s;
    }
    .sticky-top nav a:hover {
      color: var(--accent);
    }
    .page-title { text-align: center; color: var(--primary-dark); font-weight: 600; margin: 1.5rem 0 1rem; font-size: 1.5rem; }
    .error { background:#f8d7da; color:#721c24; padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center; border:1px solid #f5c6cb; }
    .success { background:#d4edda; color:#155724; padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center; border:1px solid #c3e6cb; }
    .no-data { text-align:center; color:var(--gray); font-style:italic; padding:2rem; background:white; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
    
    /* SECTION STYLES */
    .section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    .section h3 {
      margin: 0 0 1rem;
      font-size: 1.25rem;
      color: var(--primary-dark);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    .controls {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .btn-delete-all {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-delete-all:hover { background: #c82333; }
    .btn-download {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-download:hover { background: var(--primary-dark); }
    
    /* TABLE STYLES */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    thead th {
      background: var(--primary);
      color: white;
      padding: 0.75rem 0.5rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.85rem;
    }
    tbody td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:hover {
      background: #f8f9fa;
    }
    .actions {
      white-space: nowrap;
    }
    .delete-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .delete-btn:hover { background: #c82333; }
    
    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1rem;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      margin: 0 0 1rem;
      color: var(--primary-dark);
      font-weight: 600;
    }
    #modal-message {
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    .modal-actions button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
    }
    #cancel-delete {
      background: #6c757d;
      color: white;
      border: none;
    }
    #confirm-delete {
      background: var(--danger);
      color: white;
      border: none;
    }
    
    main { flex: 1; }
    
    @media (max-width: 768px) {
      .controls { justify-content: center; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; background: white; }
      td {
        border: none;
        position: relative;
        padding-left: 50%;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      td::before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        width: 45%;
        font-weight: 600;
        color: var(--primary-dark);
      }
      .actions { text-align: right; padding-left: 1rem; }
    }
  </style>
</head>
<body>
  <div class="sticky-top">
    <header>
      <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        max-width: 100%;
        padding: 0 1rem;
      ">
        <a href="/" style="display: block; line-height: 0;">
          <img src="/images/caf.png"
               alt="ANL Logo"
               style="height: 40px; width: auto;">
        </a>
        <h1 style="
          margin: 0;
          font-size: 2rem;
          font-weight: 700;
          color: white;
          text-align: center;
          flex: 1;
        ">
          <%= title %>
        </h1>
      </div>
    </header>
    <nav>
      <a href="/">Home</a> |
      <a href="/bracket">Bracket</a> |
      <a href="/rankings">Rankings</a> |
      <a href="/teams">Teams</a> |
      <% if (typeof user !== 'undefined' && user) { %>
        <% if (user.role === 'admin') { %>
          <a href="/admin/dashboard">Admin Dashboard</a> |
          <a href="/admin/data">Data Overview</a> |
        <% } else { %>
          <a href="/dashboard">Dashboard</a> |
        <% } %>
        <a href="/auth/logout">Logout</a>
      <% } else { %>
        <a href="/login">Login</a> |
        <a href="/signup">Sign Up</a>
      <% } %>
    </nav>
  </div>

  <main class="container">
    <h2 class="page-title">Admin Data Overview</h2>
    <% if (error) { %>
      <p class="error"><%= error %></p>
    <% } %>
    <% if (message) { %>
      <p class="success"><%= message %></p>
    <% } %>

    <!-- ==================== USERS ==================== -->
    <div class="section">
      <h3>Users (<%= users.length %>)</h3>
      <div class="controls">
        <button type="button" class="btn-delete-all delete-all-btn"
                data-url="/admin/delete-all-users"
                data-message="Delete ALL users?">
          Delete All Users
        </button>
        <button class="btn-download" onclick="downloadExcel('users', <%= JSON.stringify(users.map(u => ({ ...u, team: u.team ? u.team.toString() : null }))) %>)">
          Download Users Excel
        </button>
      </div>
      <% if (users.length === 0) { %>
        <div class="no-data">No users found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Team</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(u => { %>
              <tr>
                <td data-label="Username"><%= u.username %></td>
                <td data-label="Email"><%= u.email %></td>
                <td data-label="Role"><%= u.role %></td>
                <td data-label="Team">
                  <%
                    const userTeamId = u.team ? u.team.toString() : null;
                    const teamObj = teams.find(t => t._id.toString() === userTeamId);
                  %>
                  <%= teamObj ? teamObj.country : 'None' %>
                </td>
                <td data-label="Actions" class="actions">
                  <button type="button" class="delete-btn"
                          data-id="<%= u._id %>"
                          data-name="<%= u.username %>"
                          data-type="user"
                          data-url="/admin/delete-user/<%= u._id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- ==================== TEAMS ==================== -->
    <div class="section">
      <h3>Teams (<%= teams.length %>)</h3>
      <div class="controls">
        <button type="button" class="btn-delete-all delete-all-btn"
                data-url="/admin/delete-all-teams"
                data-message="Delete ALL teams?">
          Delete All Teams
        </button>
        <button class="btn-download" onclick="downloadExcel('teams', <%= JSON.stringify(teams) %>)">
          Download Teams Excel
        </button>
      </div>
      <% if (teams.length === 0) { %>
        <div class="no-data">No teams found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Country</th>
              <th>Manager</th>
              <th>Rep</th>
              <th>Rating</th>
              <th>Squad</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% teams.forEach(t => { %>
              <tr>
                <td data-label="Country"><%= t.country %></td>
                <td data-label="Manager"><%= t.manager %></td>
                <td data-label="Rep"><%= t.representative_id?.username || 'N/A' %></td>
                <td data-label="Rating"><%= isNaN(t.rating) ? '0.0' : t.rating.toFixed(1) %></td>
                <td data-label="Squad"><%= Array.isArray(t.squad) ? t.squad.length : 0 %> players</td>
                <td data-label="Actions" class="actions">
                  <button type="button" class="delete-btn"
                          data-id="<%= t._id %>"
                          data-name="<%= t.country %>"
                          data-type="team"
                          data-url="/admin/delete-team/<%= t._id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- ==================== PAST TOURNAMENTS ==================== -->
    <div class="section">
      <h3>Past-tournaments (<%= pasttournaments.length %>)</h3>
      <div class="controls">
        <button type="button" class="btn-delete-all delete-all-btn"
                data-url="/admin/delete-all-pasttournaments"
                data-message="Delete ALL past-tournaments?">
          Delete All
        </button>
        <button class="btn-download" onclick="downloadExcel('pasttournaments', <%= JSON.stringify(pasttournaments) %>)">
          Download Excel
        </button>
      </div>
      <% if (pasttournaments.length === 0) { %>
        <div class="no-data">No Past-tournaments found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Teams</th>
              <th>Stage</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% pasttournaments.forEach(t => { %>
              <tr>
                <td data-label="Status"><%= t.status || 'Unknown' %></td>
                <td data-label="Teams"><%= Array.isArray(t.teams) ? t.teams.length : 0 %></td>
                <td data-label="Stage"><%= t.status || '—' %></td>
                <td data-label="Created"><%= t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '—' %></td>
                <td data-label="Actions" class="actions">
                  <button type="button" class="delete-btn"
                          data-id="<%= t._id %>"
                          data-name="pasttournaments #<%= t._id %>"
                          data-type="pasttournaments"
                          data-url="/admin/delete-pasttournaments/<%= t._id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- ==================== MATCHES ==================== -->
    <div class="section">
      <h3>Matches (<%= matches.length %>)</h3>
      <div class="controls">
        <button type="button" class="btn-delete-all delete-all-btn"
                data-url="/admin/delete-all-matches"
                data-message="Delete ALL matches?">
          Delete All
        </button>
        <button class="btn-download" onclick="downloadExcel('matches', <%= JSON.stringify(matches) %>)">
          Download Excel
        </button>
      </div>
      <% if (matches.length === 0) { %>
        <div class="no-data">No matches found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Team 1</th>
              <th>Score</th>
              <th>Team 2</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% matches.forEach(m => { %>
              <tr>
                <td data-label="Team 1"><%= m.team1_id?.country || 'TBD' %></td>
                <td data-label="Score"><%= m.score?.team1 ?? 0 %>–<%= m.score?.team2 ?? 0 %></td>
                <td data-label="Team 2"><%= m.team2_id?.country || 'TBD' %></td>
                <td data-label="Status"><%= m.status || '—' %></td>
                <td data-label="Actions" class="actions">
                  <button type="button" class="delete-btn"
                          data-id="<%= m._id %>"
                          data-name="<%= (m.team1_id?.country || 'TBD') %> vs <%= (m.team2_id?.country || 'TBD') %>"
                          data-type="match"
                          data-url="/admin/delete-match/<%= m._id %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </main>

  <!-- ==================== DELETE MODAL (shared) ==================== -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <h3>Confirm Deletion</h3>
      <p id="modal-message"></p>
      <div class="modal-actions">
        <button id="cancel-delete">Cancel</button>
        <form id="delete-form" action="" method="POST" style="display:inline;">
          <button type="submit" id="confirm-delete">Confirm Delete</button>
        </form>
      </div>
    </div>
  </div>

  <footer style="
    background: linear-gradient(135deg, #1a3f35, #2e6b5b);
    color: white;
    padding: 2rem 1rem;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    font-family: 'Roboto', sans-serif;">
    <div class="container" style="max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="/images/caf.png" alt="ANL Logo" style="height: 36px; width: auto;">
        <div>
          <div style="font-weight: 700; font-size: 1.1rem;">African Nations League</div>
          <div style="font-size: 0.85rem; opacity: 0.9;">Official Platform</div>
        </div>
      </div>
      <div style="text-align: center; flex: 1; min-width: 200px;">
        <a href="/" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Home</a>
        <a href="/bracket" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Bracket</a>
        <a href="/rankings" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Rankings</a>
        <a href="/teams" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Teams</a>
      </div>
      <div style="text-align: right; font-size: 0.8rem; opacity: 0.8;">
        © <%= new Date().getFullYear() %> ANL<br>
        <span style="font-size: 0.75rem;">Powered by WGS - UCT</span>
      </div>
    </div>
  </footer>

  <!-- ==================== SCRIPTS ==================== -->
  <script>
    /* ---------- Excel Export ---------- */
    async function downloadExcel(type, data) {
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet(type.charAt(0).toUpperCase() + type.slice(1));
      let headers = [];
      let rows = [];
      if (type === 'users') {
        headers = ['Username', 'Email', 'Role', 'Team'];
        rows = data.map(u => [
          u.username,
          u.email,
          u.role,
          u.team ? (teams.find(t => t._id === u.team)?.country || 'None') : 'None'
        ]);
      } else if (type === 'teams') {
        headers = ['Country', 'Manager', 'Rep', 'Rating', 'Squad Size'];
        rows = data.map(t => [
          t.country,
          t.manager,
          t.representative_id?.username || 'N/A',
          t.rating?.toFixed(1) || '0.0',
          t.squad?.length || 0
        ]);
      } else if (type === 'pasttournaments') {
        headers = ['Status', 'Teams', 'Stage', 'Created'];
        rows = data.map(t => [
          t.status || '—',
          t.teams?.length || 0,
          t.status || '—',
          t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '—'
        ]);
      } else if (type === 'matches') {
        headers = ['Stage', 'Team 1', 'Score', 'Team 2', 'Status'];
        rows = data.map(m => [
          m.stage || '—',
          m.team1_id?.country || 'TBD',
          `${m.score?.team1 ?? 0}–${m.score?.team2 ?? 0}`,
          m.team2_id?.country || 'TBD',
          m.status || '—'
        ]);
      }
      ws.addRow(headers).font = { bold: true, color: { argb: 'FFFFFFFF' } };
      ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2e6b5b' } };
      rows.forEach(row => ws.addRow(row));
      ws.columns.forEach(col => {
        col.width = 18;
        col.alignment = { vertical: 'middle', horizontal: 'left' };
      });
      ws.eachRow((row) => {
        row.eachCell(cell => {
          cell.border = {
            top: { style: 'thin' }, left: { style: 'thin' },
            bottom: { style: 'thin' }, right: { style: 'thin' }
          };
        });
      });
      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf]), `${type}_report_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    /* ---------- DELETE MODAL LOGIC ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('delete-modal');
      const msgSpan = document.getElementById('modal-message');
      const deleteForm = document.getElementById('delete-form');
      const cancelBtn = document.getElementById('cancel-delete');

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.dataset.name;
          const url = btn.dataset.url;
          msgSpan.innerHTML = `Are you sure you want to delete <strong>${name}</strong>?`;
          deleteForm.action = url;
          modal.style.display = 'flex';
        });
      });

      document.querySelectorAll('.delete-all-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const url = btn.dataset.url;
          const message = btn.dataset.message;
          msgSpan.innerHTML = `<strong>${message}</strong>`;
          deleteForm.action = url;
          modal.style.display = 'flex';
        });
      });

      cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });

      modal.addEventListener('click', e => {
        if (e.target === modal) modal.style.display = 'none';
      });

      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
          modal.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>