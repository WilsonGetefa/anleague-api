<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/images/caf.png">

    <!-- ExcelJS + FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* ... (all your CSS from before – unchanged) ... */
        :root { --primary: #2e6b5b; --primary-dark: #1a3f35; --accent: #e67e22; --light: #f8f9fa; --gray: #6c757d; --border: #dee2e6; }
        html, body { height: 100%; margin: 0; }
        body { font-family: 'Roboto', sans-serif; background: #f4f6f9; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .sticky-top { position: sticky; top: 0; z-index: 1000; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .sticky-top header { text-align: center; padding: 1rem; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 0 0 16px 16px; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .sticky-top nav { background: white; padding: 1rem; text-align: center; border-bottom: 1px solid #eee; }
        .sticky-top nav a { margin: 0 10px; color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.95rem; }
        .sticky-top nav a:hover { color: var(--accent); }
        .page-title { text-align: center; color: var(--primary-dark); font-weight: 600; margin: 1.5rem 0 1rem; font-size: 1.5rem; }
        .error { background:#f8d7da; color:#721c24; padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center; border:1px solid #f5c6cb; }
        .success { background:#d4edda; color:#155724; padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center; border:1px solid #c3e6cb; }
        .section { margin-bottom: 3rem; }
        .section h3 { color: var(--primary-dark); font-size: 1.3rem; margin: 1.5rem 0 1rem; padding-bottom: .4rem; border-bottom: 2px solid var(--primary); display: inline-block; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: .5rem; }
        .controls button { padding: .6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .9rem; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-delete-all { background: #c82333; color: white; }
        .btn-download { background: #28a745; color: white; }
        .btn-delete:hover, .btn-delete-all:hover { opacity: .9; }
        .btn-download:hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        th, td { padding: .8rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--primary); color: white; font-weight: 600; font-size: .9rem; }
        tr:hover td { background: #f8f9fa; }
        .actions button { background: none; border: none; color: #dc3545; font-size: 1.1rem; cursor: pointer; padding: 0.4rem 0.6rem; border-radius: 6px; }
        .actions button:hover { background: #f8d7da; color: #c82333; }
        .no-data { text-align:center; color:var(--gray); font-style:italic; padding:2rem; background:white; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); max-width: 400px; width: 90%; text-align: center; }
        .modal-content h3 { margin: 0 0 1rem; color: #721c24; font-size: 1.4rem; }
        .modal-content p { margin: 0 0 1.5rem; color: #333; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: center; gap: 1rem; }
        .modal-actions button { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; min-width: 100px; }
        #cancel-delete { background: #6c757d; color: white; }
        #confirm-delete { background: #dc3545; color: white; }
        .modal-actions button:hover { opacity: .9; }
        @media (max-width:768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; }
            td { border: none; position: relative; padding-left: 50%; }
            td::before { content: attr(data-label); position: absolute; left: 1rem; width: 45%; font-weight: 600; }
            }
    </style>
    </head>
    <body>
    <!-- ==================== HEADER & NAV ==================== -->
    <div class="sticky-top">
        <header>
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; max-width: 100%; padding: 0 1rem;">
            <a href="/" style="display: block; line-height: 0;">
            <img src="/images/caf.png" alt="ANL Logo" style="height: 40px; width: auto;">
            </a>
            <h1 style="margin: 0; font-size: 2rem; font-weight: 700; color: white; text-align: center; flex: 1;">
            <%= title %>
            </h1>
        </div>
        </header>

        <nav>
        <a href="/">Home</a> |
        <a href="/bracket">Bracket</a> |
        <a href="/rankings">Rankings</a> |
        <a href="/teams">Teams</a> |
        <% if (typeof user !== 'undefined' && user) { %>
            <% if (user.role === 'admin') { %>
            <a href="/admin/dashboard">Admin Dashboard</a> |
            <a href="/admin/data">Data Overview</a> |
            <% } else { %>
            <a href="/dashboard">Dashboard</a> |
            <% } %>
            <a href="/auth/logout">Logout</a>
        <% } else { %>
            <a href="/login">Login</a> |
            <a href="/signup">Sign Up</a>
        <% } %>
        </nav>
    </div>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="container">
        <h2 class="page-title">Admin Data Overview</h2>

        <% if (error) { %>
        <p class="error"><%= error %></p>
        <% } %>
        <% if (message) { %>
        <p class="success"><%= message %></p>
        <% } %>

        <!-- ==================== CURRENT TOURNAMENT ==================== -->
        <div class="section">
        <h3>Current Tournament</h3>
        <% if (tournament) { %>
            <p>
            <strong>Status:</strong> <%= tournament.status %> |
            <strong>Teams:</strong> <%= Array.isArray(tournament.teams) ? tournament.teams.length : 0 %> |
            <strong>Created:</strong> <%= tournament.createdAt ? new Date(tournament.createdAt).toLocaleDateString() : '—' %>
            </p>
        <% } else { %>
            <div class="no-data">No active tournament.</div>
        <% } %>
        </div>

        <!-- ==================== USERS ==================== -->
        <div class="section">
        <h3>Users (<%= users.length %>)</h3>
        <div class="controls">
            <button type="button" class="btn-delete-all delete-all-btn"
                    data-url="/admin/delete-all-users"
                    data-message="Delete ALL users?">
            Delete All Users
            </button>
            <button type="button" class="btn-download"
                    data-type="users"
                    data-payload="<%= JSON.stringify(users.map(u => ({ ...u, team: u.team ? u.team.toString() : null }))) %>">
            Download Users Excel
            </button>
        </div>

        <% if (users.length === 0) { %>
            <div class="no-data">No users found.</div>
        <% } else { %>
            <table>
            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Team</th><th>Actions</th></tr></thead>
            <tbody>
                <% users.forEach(u => { %>
                <tr>
                    <td><%= u.username %></td>
                    <td><%= u.email %></td>
                    <td><%= u.role %></td>
                    <td>
                    <% const teamObj = teams.find(t => t._id.toString() === (u.team ? u.team.toString() : '')); %>
                    <%= teamObj ? teamObj.country : 'None' %>
                    </td>
                    <td class="actions">
                    <button type="button" class="delete-btn"
                            data-name="<%= u.username %>"
                            data-url="/admin/delete-user/<%= u._id %>">
                        Delete
                    </button>
                    </td>
                </tr>
                <% }) %>
            </tbody>
            </table>
        <% } %>
        </div>

        <!-- ==================== TEAMS ==================== -->
        <div class="section">
        <h3>Teams (<%= teams.length %>)</h3>
        <div class="controls">
            <button type="button" class="btn-delete-all delete-all-btn"
                    data-url="/admin/delete-all-teams"
                    data-message="Delete ALL teams?">
            Delete All Teams
            </button>
            <button type="button" class="btn-download"
                    data-type="teams"
                    data-payload="<%= JSON.stringify(teams) %>">
            Download Teams Excel
            </button>
        </div>

        <% if (teams.length === 0) { %>
            <div class="no-data">No teams found.</div>
        <% } else { %>
            <table>
            <thead><tr><th>Country</th><th>Manager</th><th>Rep</th><th>Rating</th><th>Squad</th><th>Actions</th></tr></thead>
            <tbody>
                <% teams.forEach(t => { %>
                <tr>
                    <td><%= t.country %></td>
                    <td><%= t.manager %></td>
                    <td><%= t.representative_id?.username || 'N/A' %></td>
                    <td><%= isNaN(t.rating) ? '0.0' : t.rating.toFixed(1) %></td>
                    <td><%= Array.isArray(t.squad) ? t.squad.length : 0 %> players</td>
                    <td class="actions">
                    <button type="button" class="delete-btn"
                            data-name="<%= t.country %>"
                            data-url="/admin/delete-team/<%= t._id %>">
                        Delete
                    </button>
                    </td>
                </tr>
                <% }) %>
            </tbody>
            </table>
        <% } %>
        </div>

        <!-- ==================== PAST TOURNAMENTS ==================== -->
        <div class="section">
        <h3>Past Tournaments (<%= pasttournaments.length %>)</h3>
        <div class="controls">
            <button type="button" class="btn-delete-all delete-all-btn"
                    data-url="/admin/delete-all-pasttournaments"
                    data-message="Delete ALL past tournaments?">
            Delete All
            </button>
            <button type="button" class="btn-download"
                    data-type="pasttournaments"
                    data-payload="<%= JSON.stringify(pasttournaments.map(t => ({
                    status: t.status || '—',
                    teams: Array.isArray(t.teams) ? t.teams.length : 0,
                    stage: t.status || '—',
                    created: t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '—'
                    }))) %>">
            Download Excel
            </button>
        </div>

        <% if (pasttournaments.length === 0) { %>
            <div class="no-data">No past tournaments found.</div>
        <% } else { %>
            <table>
            <thead><tr><th>Status</th><th>Teams</th><th>Stage</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>
                <% pasttournaments.forEach(t => { %>
                <tr>
                    <td><%= t.status || 'Unknown' %></td>
                    <td><%= Array.isArray(t.teams) ? t.teams.length : 0 %></td>
                    <td><%= t.status || '—' %></td>
                    <td><%= t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '—' %></td>
                    <td class="actions">
                    <button type="button" class="delete-btn"
                            data-name="Tournament #<%= t._id %>"
                            data-url="/admin/delete-pasttournaments/<%= t._id %>">
                        Delete
                    </button>
                    </td>
                </tr>
                <% }) %>
            </tbody>
            </table>
        <% } %>
        </div>

        <!-- ==================== MATCHES ==================== -->
        <div class="section">
        <h3>Matches (<%= matches.length %>)</h3>
        <div class="controls">
            <button type="button" class="btn-delete-all delete-all-btn"
                    data-url="/admin/delete-all-matches"
                    data-message="Delete ALL matches?">
            Delete All
            </button>
            <button type="button" class="btn-download"
                    data-type="matches"
                    data-payload="<%= JSON.stringify(matches) %>">
            Download Excel
            </button>
        </div>

        <% if (matches.length === 0) { %>
            <div class="no-data">No matches found.</div>
        <% } else { %>
            <table>
            <thead><tr><th>Team 1</th><th>Score</th><th>Team 2</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
                <% matches.forEach(m => { %>
                <tr>
                    <td><%= m.team1_id?.country || 'TBD' %></td>
                    <td><%= m.score?.team1 ?? 0 %>–<%= m.score?.team2 ?? 0 %></td>
                    <td><%= m.team2_id?.country || 'TBD' %></td>
                    <td><%= m.status || '—' %></td>
                    <td class="actions">
                    <button type="button" class="delete-btn"
                            data-name="<%= (m.team1_id?.country || 'TBD') %> vs <%= (m.team2_id?.country || 'TBD') %>"
                            data-url="/admin/delete-match/<%= m._id %>">
                        Delete
                    </button>
                    </td>
                </tr>
                <% }) %>
            </tbody>
            </table>
        <% } %>
        </div>
    </main>

    <!-- ==================== DELETE MODAL ==================== -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p id="modal-message"></p>
        <div class="modal-actions">
            <button id="cancel-delete">Cancel</button>
            <form id="delete-form" action="" method="POST" style="display:inline;">
            <button type="submit" id="confirm-delete">Confirm Delete</button>
            </form>
        </div>
        </div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->
     <script>
  // Global data - CORRECT EJS SYNTAX
  const allTeams = <%- JSON.stringify(teams) %>;

  // Excel Export
  async function downloadExcel(type, rawData) {
    const data = JSON.parse(rawData);
    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet(type.charAt(0).toUpperCase() + type.slice(1));

    let headers = [], rows = [];

    if (type === 'users') {
      headers = ['Username', 'Email', 'Role', 'Team'];
      rows = data.map(u => [
        u.username,
        u.email,
        u.role,
        u.team ? (allTeams.find(t => t._id === u.team)?.country || 'None') : 'None'
      ]);
    } else if (type === 'teams') {
      headers = ['Country', 'Manager', 'Rep', 'Rating', 'Squad Size'];
      rows = data.map(t => [
        t.country,
        t.manager,
        t.representative_id?.username || 'N/A',
        isNaN(t.rating) ? '0.0' : Number(t.rating).toFixed(1),
        Array.isArray(t.squad) ? t.squad.length : 0
      ]);
    } else if (type === 'pasttournaments') {
      headers = ['Status', 'Teams', 'Stage', 'Created'];
      rows = data.map(t => [t.status, t.teams, t.stage, t.created]);
    } else if (type === 'matches') {
      headers = ['Stage', 'Team 1', 'Score', 'Team 2', 'Status'];
      rows = data.map(m => [
        m.stage || '—',
        m.team1_id?.country || 'TBD',
        `${m.score?.team1 ?? 0}–${m.score?.team2 ?? 0}`,
        m.team2_id?.country || 'TBD',
        m.status || '—'
      ]);
    }

    ws.addRow(headers).font = { bold: true, color: { argb: 'FFFFFFFF' } };
    ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2e6b5b' } };
    rows.forEach(r => ws.addRow(r));

    ws.columns.forEach(c => {
      c.width = 18;
      c.alignment = { vertical: 'middle', horizontal: 'left' };
    });

    ws.eachRow(row => {
      row.eachCell(cell => {
        cell.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
      });
    });

    const buf = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]), `${type}_report_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // Attach all buttons
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('delete-modal');
    const msgSpan = document.getElementById('modal-message');
    const deleteForm = document.getElementById('delete-form');
    const cancelBtn = document.getElementById('cancel-delete');

    // Excel buttons
    document.querySelectorAll('.btn-download').forEach(btn => {
      btn.addEventListener('click', () => {
        downloadExcel(btn.dataset.type, btn.dataset.payload);
      });
    });

    // Single delete
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        msgSpan.innerHTML = `Delete <strong>${btn.dataset.name}</strong>?`;
        deleteForm.action = btn.dataset.url;
        modal.style.display = 'flex';
      });
    });

    // Delete all
    document.querySelectorAll('.delete-all-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        msgSpan.innerHTML = `<strong>${btn.dataset.message}</strong>`;
        deleteForm.action = btn.dataset.url;
        modal.style.display = 'flex';
      });
    });

    // Close modal
    cancelBtn.onclick = () => modal.style.display = 'none';
    modal.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };
    document.onkeydown = e => { if (e.key === 'Escape') modal.style.display = 'none'; };
  });
</script>
    </body>
</html>
