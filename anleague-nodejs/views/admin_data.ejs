<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" type="image/x-icon" href="/images/caf.png">

  <!-- ExcelJS + FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root {
      --primary: #2e6b5b;
      --primary-dark: #1a3f35;
      --accent: #e67e22;
      --light: #f8f9fa;
      --gray: #6c757d;
      --border: #dee2e6;
      --gold: #d4af37;
      --empty-star: #cccccc;
    }

    body { 
      font-family: 'Roboto', sans-serif; 
      background: #f4f6f9; 
      color: #333; 
      margin: 0;
    }

    .container { 
      max-width: 1100px; 
      margin: 2rem auto; 
      padding: 0 1rem; 
    }

    header {
      text-align: center;
      padding: 2rem 1rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 0 0 16px 16px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    header h1 { margin: 0; font-size: 2rem; font-weight: 700; }

    nav {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    nav a { margin: 0 6px; color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.95rem; }
    nav a:hover { color: var(--accent); }
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sticky-top header {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border-radius: 0;
        margin-bottom: 0;
        padding: 1rem 0;
        }

        .sticky-top nav {
        background: white;
        padding: 0.8rem 1rem;
        text-align: center;
        border-bottom: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .sticky-top nav a {
        margin: 0 10px;
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95rem;
        transition: color 0.2s;
        }

        .sticky-top nav a:hover {
        color: var(--accent);
        }

    .page-title { text-align: center; color: var(--primary-dark); font-weight: 600; margin: 1.5rem 0 1rem; font-size: 1.5rem; }

    .error { background:#f8d7da; color:#721c24; padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center; border:1px solid #f5c6cb; }
    .success { background:#d4edda; color:#155724; padding:1rem; border-radius:8px; margin-bottom:1.5rem; text-align:center; border:1px solid #c3e6cb; }

    .section { margin-bottom: 3rem; }
    .section h3 {
      color: var(--primary-dark);
      font-size: 1.3rem;
      margin: 1.5rem 0 1rem;
      padding-bottom: .4rem;
      border-bottom: 2px solid var(--primary);
      display: inline-block;
    }

    .controls {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: .5rem;
    }
    .controls button {
      padding: .6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: .9rem;
    }
    .btn-delete { background: #dc3545; color: white; }
    .btn-delete-all { background: #c82333; color: white; }
    .btn-download { background: #28a745; color: white; }
    .btn-delete:hover, .btn-delete-all:hover { opacity: .9; }
    .btn-download:hover { background: #218838; }

    table {
      width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 1.5rem;
    }
    th, td {
      padding: .8rem 1rem; text-align: left; border-bottom: 1px solid var(--border);
    }
    th {
      background: var(--primary); color: white; font-weight: 600; font-size: .9rem;
    }
    tr:hover td { background: #f8f9fa; }
    .actions { white-space: nowrap; }
    .actions form { display: inline; }
    .actions button {
      background: none; border: none; color: #dc3545; font-size: 1.1rem; cursor: pointer;
    }
    .actions button:hover { color: #c82333; }

    .no-data { text-align:center; color:var(--gray); font-style:italic; padding:2rem; background:white; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.08); }

    @media (max-width:768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; }
      td { border: none; position: relative; padding-left: 50%; }
      td::before { content: attr(data-label); position: absolute; left: 1rem; width: 45%; font-weight: 600; }
    }
  </style>
</head>
<body>
    <div class="sticky-top">
    <header>
        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; max-width: 100%; padding: 0 1rem;">
        <a href="/" style="display: block; line-height: 0;">
            <img src="/images/caf.png" alt="ANL Logo" style="height: 40px; width: auto;">
        </a>
        <h1 style="margin: 0; font-size: 2rem; font-weight: 700; color: white; text-align: center; flex: 1;">
            <%= title %>
        </h1>
        </div>
    </header>

    <nav>
        <a href="/">Home</a> |
        <a href="/bracket">Bracket</a> |
        <a href="/rankings">Rankings</a> |
        <a href="/teams">Teams</a> |
        <% if (typeof user !== 'undefined' && user) { %>
        <% if (user.role === 'admin') { %>
            <a href="/admin/dashboard">Admin Dashboard</a> |
            <a href="/admin/data">Data Overview</a> |
        <% } else { %>
            <a href="/dashboard">Dashboard</a> |
        <% } %>
        <a href="/auth/logout">Logout</a>
        <% } else { %>
        <a href="/login">Login</a> |
        <a href="/signup">Sign Up</a>
        <% } %>
    </nav>
    </div>

  <main class="container">
    <h2 class="page-title">Admin Data Overview</h2>

    <% if (error) { %>
      <p class="error"><%= error %></p>
    <% } %>
    <% if (message) { %>
      <p class="success"><%= message %></p>
    <% } %>

    <!-- USERS -->
    <div class="section">
      <h3>Users (<%= users.length %>)</h3>
      <div class="controls">
        <form action="/admin/delete-all-users" method="POST" onsubmit="return confirm('Delete ALL users?')">
          <button type="submit" class="btn-delete-all">Delete All Users</button>
        </form>
        <button class="btn-download" onclick="downloadExcel('users', <%= JSON.stringify(users.map(u => ({ ...u, team: u.team ? u.team.toString() : null }))) %>)">
          Download Users Excel
        </button>
      </div>

      <% if (users.length === 0) { %>
        <div class="no-data">No users found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Team</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(u => { %>
              <tr>
                <td data-label="Username"><%= u.username %></td>
                <td data-label="Email"><%= u.email %></td>
                <td data-label="Role"><%= u.role %></td>
                <td data-label="Team">
                  <% 
                    const userTeamId = u.team ? u.team.toString() : null;
                    const teamObj = teams.find(t => t._id.toString() === userTeamId);
                  %>
                  <%= teamObj ? teamObj.country : 'None' %>
                </td>
                <td data-label="Actions" class="actions">
                  <form action="/admin/delete-user/<%= u._id %>" method="POST" onsubmit="return confirm('Delete <%= u.username %>?')">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- TEAMS -->
    <div class="section">
      <h3>Teams (<%= teams.length %>)</h3>
      <div class="controls">
        <form action="/admin/delete-all-teams" method="POST" onsubmit="return confirm('Delete ALL teams?')">
          <button type="submit" class="btn-delete-all">Delete All Teams</button>
        </form>
        <button class="btn-download" onclick="downloadExcel('teams', <%= JSON.stringify(teams) %>)">
          Download Teams Excel
        </button>
      </div>

      <% if (teams.length === 0) { %>
        <div class="no-data">No teams found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Country</th>
              <th>Manager</th>
              <th>Rep</th>
              <th>Rating</th>
              <th>Squad</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% teams.forEach(t => { %>
              <tr>
                <td data-label="Country"><%= t.country %></td>
                <td data-label="Manager"><%= t.manager %></td>
                <td data-label="Rep"><%= t.representative_id?.username || 'N/A' %></td>
                <td data-label="Rating"><%= isNaN(t.rating) ? '0.0' : t.rating.toFixed(1) %></td>
                <td data-label="Squad"><%= Array.isArray(t.squad) ? t.squad.length : 0 %> players</td>
                <td data-label="Actions" class="actions">
                  <form action="/admin/delete-team/<%= t._id %>" method="POST" onsubmit="return confirm('Delete <%= t.country %>?')">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- TOURNAMENTS -->
    <div class="section">
      <h3>Tournaments (<%= tournaments.length %>)</h3>
      <div class="controls">
        <form action="/admin/delete-all-tournaments" method="POST" onsubmit="return confirm('Delete ALL tournaments?')">
          <button type="submit" class="btn-delete-all">Delete All</button>
        </form>
        <button class="btn-download" onclick="downloadExcel('tournaments', <%= JSON.stringify(tournaments) %>)">
          Download Excel
        </button>
      </div>

      <% if (tournaments.length === 0) { %>
        <div class="no-data">No tournaments found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Teams</th>
              <th>Stage</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% tournaments.forEach(t => { %>
              <tr>
                <td data-label="Status"><%= t.status || 'Unknown' %></td>
                <td data-label="Teams"><%= Array.isArray(t.teams) ? t.teams.length : 0 %></td>
                <td data-label="Stage"><%= t.status || '—' %></td>
                <td data-label="Created"><%= t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '—' %></td>
                <td data-label="Actions" class="actions">
                  <form action="/admin/delete-tournament/<%= t._id %>" method="POST" onsubmit="return confirm('Delete this tournament?')">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

    <!-- MATCHES -->
    <div class="section">
      <h3>Matches (<%= matches.length %>)</h3>
      <div class="controls">
        <form action="/admin/delete-all-matches" method="POST" onsubmit="return confirm('Delete ALL matches?')">
          <button type="submit" class="btn-delete-all">Delete All</button>
        </form>
        <button class="btn-download" onclick="downloadExcel('matches', <%= JSON.stringify(matches) %>)">
          Download Excel
        </button>
      </div>

      <% if (matches.length === 0) { %>
        <div class="no-data">No matches found.</div>
      <% } else { %>
        <table>
          <thead>
            <tr>
              <th>Stage</th>
              <th>Team 1</th>
              <th>Score</th>
              <th>Team 2</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% matches.forEach(m => { %>
              <tr>
                <td data-label="Stage"><%= m.stage || '—' %></td>
                <td data-label="Team 1"><%= m.team1_id?.country || 'TBD' %></td>
                <td data-label="Score"><%= m.score?.team1 ?? 0 %>–<%= m.score?.team2 ?? 0 %></td>
                <td data-label="Team 2"><%= m.team2_id?.country || 'TBD' %></td>
                <td data-label="Status"><%= m.status || '—' %></td>
                <td data-label="Actions" class="actions">
                  <form action="/admin/delete-match/<%= m._id %>" method="POST" onsubmit="return confirm('Delete this match?')">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>
  </main>
  <footer style="
  background: linear-gradient(135deg, #1a3f35, #2e6b5b);
  color: white;
  padding: 2rem 1rem;
  margin-top: 3rem;
  border-radius: 16px 16px 0 0;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
  font-family: 'Roboto', sans-serif;
">
  <div class="container" style="max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    
    <div style="display: flex; align-items: center; gap: 12px;">
      <img src="/images/caf.png" alt="ANL Logo" style="height: 36px; width: auto;">
      <div>
        <div style="font-weight: 700; font-size: 1.1rem;">African Nations League</div>
        <div style="font-size: 0.85rem; opacity: 0.9;">Official Platform</div>
      </div>
    </div>

    <div style="text-align: center; flex: 1; min-width: 200px;">
      <a href="/" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Home</a>
      <a href="/bracket" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Bracket</a>
      <a href="/rankings" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Rankings</a>
      <a href="/teams" style="color: white; text-decoration: none; margin: 0 8px; font-size: 0.9rem; opacity: 0.9;">Teams</a>
    </div>

    <div style="text-align: right; font-size: 0.8rem; opacity: 0.8;">
      © <%= new Date().getFullYear() %> ANL<br>
      <span style="font-size: 0.75rem;">Powered by WGS - UCT</span>
    </div>
  </div>
</footer>

  <script>
    async function downloadExcel(type, data) {
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet(type.charAt(0).toUpperCase() + type.slice(1));

      let headers = [];
      let rows = [];

      if (type === 'users') {
        headers = ['Username', 'Email', 'Role', 'Team'];
        rows = data.map(u => [
          u.username,
          u.email,
          u.role,
          u.team ? (teams.find(t => t._id === u.team)?.country || 'None') : 'None'
        ]);
      } else if (type === 'teams') {
        headers = ['Country', 'Manager', 'Rep', 'Rating', 'Squad Size'];
        rows = data.map(t => [
          t.country,
          t.manager,
          t.representative_id?.username || 'N/A',
          t.rating?.toFixed(1) || '0.0',
          t.squad?.length || 0
        ]);
      } else if (type === 'tournaments') {
        headers = ['Status', 'Teams', 'Stage', 'Created'];
        rows = data.map(t => [
          t.status || '—',
          t.teams?.length || 0,
          t.status || '—',
          t.createdAt ? new Date(t.createdAt).toLocaleDateString() : '—'
        ]);
      } else if (type === 'matches') {
        headers = ['Stage', 'Team 1', 'Score', 'Team 2', 'Status'];
        rows = data.map(m => [
          m.stage || '—',
          m.team1_id?.country || 'TBD',
          `${m.score?.team1 ?? 0}–${m.score?.team2 ?? 0}`,
          m.team2_id?.country || 'TBD',
          m.status || '—'
        ]);
      }

      ws.addRow(headers).font = { bold: true, color: { argb: 'FFFFFFFF' } };
      ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2e6b5b' } };

      rows.forEach(row => ws.addRow(row));

      ws.columns.forEach(col => {
        col.width = 18;
        col.alignment = { vertical: 'middle', horizontal: 'left' };
      });

      ws.eachRow((row) => {
        row.eachCell(cell => {
          cell.border = {
            top: { style: 'thin' }, left: { style: 'thin' },
            bottom: { style: 'thin' }, right: { style: 'thin' }
          };
        });
      });

      const buf = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf]), `${type}_report_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
  </script>
</body>
</html>